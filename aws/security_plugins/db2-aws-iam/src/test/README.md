# Unit Tests

The unittest setup actually creates a userpool, groups, users, etc. in the AWS Cognito. And once the tests are executed, the test scripts also deletes the created userpool. The system/container where these tests are executed should have AWS developer credentials configured. In case of error, it may happen that tests fail to cleanup userpool in the AWS Cognito. Please make sure it is deleted after test execution.


## Install Dependencies

Install following dependencies in order to execute the tests -

1. Install AWS CLI from https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html. Note that installing `awscli` using yum gives you an older version of AWS CLI which lacks many new features which are needed for these tests. So, it is recommended to use following way of installing AWS CLI. 

```shell
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

2. Install python package, if not already present. Tests are tested with python 2.7 as well as 3.11.

```shell
sudo yum install python3.11
sudo ln -s /usr/bin/python3.11 /usr/bin/python
```

## Build the tests

Make sure the plugin code is built before running following command.

```shell
export INSTALLED_OPENSSL=$(openssl version | awk '{print $2}' | sed -e 's/[a-z]-*.*//' | awk -F. '{ print $1$2$3 }')
export INSTALLED_JSON_C=$(yum info installed json-c | grep Version | sed -e 's/Version\s*: //g' | awk -F. '{ print $1$2$3 }')

make clean && make all
```

## Run the tests

The unit tests written depend on the cognito setup like creating userpool, users, groups, etc. This test directory contains a few scripts to create those entities in AWS cognito and use those to execute the tests successfully.
1. `settings.sh` - This script contains the static or default settings needed by setup and tear down scripts.
2. `setup_cognito_for_tests.sh` - This script creates a userpool, creates two groups, creates one user, assigns groups to the user and dumps the generated information like USERPOOLID, CLIENTID, USERNAME_GENERATED in the `env.sh`. This script also creates a file with a name as set by variable `AWS_USERPOOL_CFG_ENV` in settings.sh
3. `teardown_cognito.sh` - This script deletes the AWS cognito userpool and removes the temporary generated files.
4. `retrieve_token.sh` - This script is used to retrieve the ID token for the test user. It is run as part of `setup_cognito_for_tests.sh` script and it dumps the generated token in `env.sh`.
5. `testAll.sh` - This script does everything i.e. it runs setup script, execute the tests, and tear down the userpool.

Some temporary output files generated by above scripts -
1. `env.sh` - This is a temporary file used to setup environment variables needed by unit tests.
2. `test_cognito_userpools.json` - This script contains userpoolID and clientID which is created in AWS and it is used by plugin code. The name of this file can be changed by updating `settings.sh`.
Make sure that above two temporary files are not commited to the repo.


```shell
./testAll.sh <test user password>
```

The `testAll.sh` script needs a password to be provided which will be set for a test user created in userpool. It can be anything that satifies the cognito password requirements.

In case the tests fail and for some reason cognito userpool created as part of test setup remains undeleted, please run below scripts -

```shell
source ./env.sh
./teardown_cognito.sh
```

# Full Test of Token Validation
There is a test file written `fulltest.c` which tests the entire flow of token validation as it is done in server side AWS IAM plugin.

This test can be individually built and run as follows -

```shell
make fullTest
./fullTest $ACCESSTOKEN
```

where `ACCESSTOKEN` is the ID/access token retrieved from AWS Cognito for a user who is part of userpool.

Note: Any change done in the token validation function `validate_auth_info` in server side plugin (`AWSIAMauthserver.c`) should be made in fulltest.c file too.
