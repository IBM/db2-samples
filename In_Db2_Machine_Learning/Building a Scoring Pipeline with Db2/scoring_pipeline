CREATE OR REPLACE PROCEDURE mingpang.pipe(IN ID_VALUE INT, IN GENDER_VALUE VARCHAR(10),IN AGE_VALUE DOUBLE, IN MARITAL_STATUS_VALUE VARCHAR(50), IN PROFESSION_VALUE VARCHAR(50),IN IS_TENT_VALUE SMALLINT, IN PRODUCT_LINE_VALUE VARCHAR(50))
LANGUAGE SQL
DYNAMIC RESULT SETS 1
MODIFIES SQL DATA
BEGIN

-- Declare block
declare myqry varchar(1024);
declare callsp varchar(1024);
declare dropt varchar(1024);
declare tname varchar(128);
declare cretemptab varchar(1024);
declare mystmt statement;
DECLARE C1 CURSOR WITH RETURN FOR mystmt;

-- Delare an input table
DECLARE GLOBAL TEMPORARY TABLE SESSION.INPUT(ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,GENDER VARCHAR(10),STD_AGE DOUBLE,MARITAL_STATUS VARCHAR(50),PROFESSION VARCHAR(50),IS_TENT SMALLINT,PRODUCT_LINE VARCHAR(50)) ON COMMIT PRESERVE ROWS WITH REPLACE;
-- Insert values into the table
INSERT INTO SESSION.INPUT(ID, GENDER, STD_AGE, MARITAL_STATUS, PROFESSION, IS_TENT, PRODUCT_LINE)
    VALUES(ID_VALUE, GENDER_VALUE, AGE_VALUE, MARITAL_STATUS_VALUE, PROFESSION_VALUE, IS_TENT_VALUE, PRODUCT_LINE_VALUE);

-- Null impute numerical columns with mean
UPDATE SESSION.INPUT SET STD_AGE = (SELECT AVERAGE FROM LINREG.GSTRAIN_STATS_NUM WHERE COLUMNNAME='AGE') WHERE STD_AGE IS NULL;
-- Null impute nominal with most frequent
UPDATE SESSION.INPUT SET GENDER = (SELECT MOSTFREQUENTVALUE FROM LINREG.GSTRAIN_STATS_CHAR WHERE COLNAME='GENDER') WHERE GENDER IS NULL;
UPDATE SESSION.INPUT SET MARITAL_STATUS = (SELECT MOSTFREQUENTVALUE FROM LINREG.GSTRAIN_STATS_CHAR WHERE COLNAME='MARITAL_STATUS') WHERE MARITAL_STATUS IS NULL;
UPDATE SESSION.INPUT SET PROFESSION = (SELECT MOSTFREQUENTVALUE FROM LINREG.GSTRAIN_STATS_CHAR WHERE COLNAME='PROFESSION') WHERE PROFESSION IS NULL;
UPDATE SESSION.INPUT SET PRODUCT_LINE = (SELECT MOSTFREQUENTVALUE FROM LINREG.GSTRAIN_STATS_CHAR WHERE COLNAME='PRODUCT_LINE') WHERE PRODUCT_LINE IS NULL;
UPDATE SESSION.INPUT SET IS_TENT = (SELECT MOSTFREQUENTVALUE FROM LINREG.GSTRAIN_STATS_CHAR WHERE COLNAME='IS_TENT') WHERE IS_TENT IS NULL;
-- Standardize Age
UPDATE SESSION.INPUT SET STD_AGE = ((CAST(STD_AGE AS FLOAT) - (SELECT AVERAGE FROM LINREG.GSTRAIN_STATS_NUM WHERE COLUMNNAME='AGE'))/(SELECT STDDEV FROM LINREG.GSTRAIN_STATS_NUM WHERE COLUMNNAME='AGE'));

-- randomly generate output table name
set tname = TRANSLATE ( CHAR(BIGINT(RAND() * 10000000000 )), 'abcdefghij', '1234567890' ) ;

-- Call predict stored procedure
set callsp = 'CALL IDAX.PREDICT_LINEAR_REGRESSION(''model=LINREG.GSLINREG, intable=SESSION.INPUT, outtable =LINREG.'||tname||', id=ID'')';
execute immediate callsp;

-- Retrieve the prediction result
set cretemptab = 'DECLARE GLOBAL TEMPORARY TABLE SESSION.TEMPTAB AS (select * from LINREG.'||tname||')  with data ON COMMIT PRESERVE ROWS WITH REPLACE';
execute immediate cretemptab;

set myqry = 'SELECT PURCHASE_AMOUNT FROM SESSION.TEMPTAB';
prepare mystmt from myqry;
open c1;

set dropt = 'DROP TABLE LINREG.'||tname;
execute immediate dropt;
END@